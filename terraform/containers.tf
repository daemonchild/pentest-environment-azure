variable "guac_env_vars" {
    type = map(string)
    description = "envvars"

    #default = {
    #  MYSQL_DATABASE = azurerm_mysql_database.db-guacamoledb.name
    #  MYSQL_USER = azurerm_mysql_server.mysqlserver.administrator_login
    #  MYSQL_PASSWORD = azurerm_mysql_server.mysqlserver.administrator_login_password
    #}

    default = {
      MYSQL_HOSTNAME = "mysql-pentestzone.mysql.database.azure.com"
      MYSQL_DATABASE = "guacamoledb"
      MYSQL_USER = "pentest"
      MYSQL_PASSWORD = "SwNU%7T2`p4;9~'aEqt3cV"
      GUACD_HOSTNAME = "guacd"
      GUACD_PORT = "4822"
    }
}

locals {
  
  guac_env_vars_attempt = {
        MYSQL_HOSTNAME = "mysql-pentestzone.mysql.database.azure.com"
        MYSQL_DATABASE = azurerm_mysql_database.db-guacamoledb.name
        MYSQL_USER = "pentest"
        MYSQL_PASSWORD = "SwNU%7T2`p4;9~'aEqt3cV"
        GUACD_HOSTNAME = "guacd"
        GUACD_PORT = "4822"
  }


}

resource "azurerm_container_group" "container_group_guacamole1" {
  name                = "cg-guacamole1"
  location            = var.location
  resource_group_name = local.resgrp
  ip_address_type     = "Private"
  subnet_ids          = [azurerm_subnet.subnetguacamole.id]
  os_type             = "Linux"

    container {

      name   = "guacamole"
      image  = "guacamole/guacamole:latest"
      cpu    = "0.5"
      memory = "1.0"

      environment_variables = var.guac_env_vars

      ports {
        port     = 8080
        protocol = "TCP"
      }

    }

    container {

      name   = "guacd"
      image  = "guacamole/guacd:latest"
      cpu    = "0.5"
      memory = "1.0"
     

      environment_variables = var.guac_env_vars

      #ports {
      #  port     = 4822
      #  protocol = "TCP"
      #}

    }

  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_subnet.subnetguacamole,
    azurerm_mysql_server.mysqlserver
  ]

  tags = local.tags

}

resource "azurerm_container_group" "container_group_guacamole2" {
  name                = "cg-guacamole2"
  location            = var.location
  resource_group_name = local.resgrp
  ip_address_type     = "Private"
  subnet_ids          = [azurerm_subnet.subnetguacamole.id]
  os_type             = "Linux"

    container {

      name   = "guacamole"
      image  = "guacamole/guacamole:latest"
      cpu    = "0.5"
      memory = "1.0"

      environment_variables = var.guac_env_vars

      ports {
        port     = 8080
        protocol = "TCP"
      }

    }

    container {

      name   = "guacd"
      image  = "guacamole/guacd:latest"
      cpu    = "0.5"
      memory = "1.0"
     

      environment_variables = var.guac_env_vars

      #ports {
      #  port     = 4822
      #  protocol = "TCP"
      #}

    }

  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_subnet.subnetguacamole,
    azurerm_mysql_server.mysqlserver
  ]

  tags = local.tags

}


resource "azurerm_container_group" "container_group_pentest" {
  name                = "cg-pentest"
  location            = var.location
  resource_group_name = local.resgrp
  ip_address_type     = "Private"
  subnet_ids          = [azurerm_subnet.subnetpentestcontainers.id]
  os_type             = "Linux"

    container {
      name   = "squid-proxy"
      image  = "daemonchild/squid-proxy:latest"
      cpu    = "0.5"
      memory = "1.0"

      ports {
        port     = 3128
        protocol = "TCP"
      }
    }

  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_subnet.subnetpentestcontainers
  ]

  tags = local.tags

}