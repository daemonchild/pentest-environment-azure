
// Project: Terraform build of a Pentesting Infrastructure
// Author:  Daemonchild
// Purpose: Build an environment for running pentests

#    __ _ _____   _ _ __ ___ 
#   / _` |_  / | | | '__/ _ \
#  | (_| |/ /| |_| | | |  __/
#   \__,_/___|\__,_|_|  \___|   Version
   
 
// Networking

locals {

  ipsubnet                = "${var.twooctets}.0.0/16"
  appgwsubnet             = "${var.twooctets}.1.0/24"
  vmsubnet                = "${var.twooctets}.2.0/24"
  guacamolesubnet         = "${var.twooctets}.3.0/24"
  pentestcontainersubnet  = "${var.twooctets}.4.0/24"

  vnetname                = "vnet-${var.project}"
  
  appgwsubnetname             = "subnet-appgw"
  vmsubnetname                = "subnet-vms"
  guacamolesubnetname         = "subnet-guacamole"
  pentestcontainersubnetname  = "subnet-pentestcontainers"

}

// Create vNet

resource "azurerm_virtual_network" "vnet" {
  address_space       = [local.ipsubnet]
  location            = var.location
  name                = local.vnetname
  resource_group_name = local.resgrp
  depends_on = [
    azurerm_resource_group.resgrp,
  ]
}

// Create Subnets

resource "azurerm_subnet" "subnetappgw" {
  address_prefixes     = [local.appgwsubnet]
  name                 = local.appgwsubnetname
  resource_group_name  = local.resgrp
  virtual_network_name = local.vnetname
  depends_on = [
    azurerm_virtual_network.vnet,
  ]
}

resource "azurerm_subnet" "subnetvms" {
  address_prefixes     = [local.vmsubnet]
  name                 = local.vmsubnetname
  resource_group_name  = local.resgrp
  virtual_network_name = local.vnetname
  depends_on = [
    azurerm_virtual_network.vnet,
  ]
}

resource "azurerm_subnet" "subnetguacamole" {
  address_prefixes     = [local.guacamolesubnet]
  name                 = local.guacamolesubnetname
  resource_group_name  = local.resgrp
  virtual_network_name = local.vnetname

  delegation {

    name = "delegation"
    service_delegation {
            name    = "Microsoft.ContainerInstance/containerGroups"
            actions = ["Microsoft.Network/virtualNetworks/subnets/join/action", "Microsoft.Network/virtualNetworks/subnets/prepareNetworkPolicies/action"]
          } 
  }

  depends_on = [
    azurerm_virtual_network.vnet,
  ]
}

resource "azurerm_subnet" "subnetpentestcontainers" {
  address_prefixes     = [local.pentestcontainersubnet]
  name                 = local.pentestcontainersubnetname
  resource_group_name  = local.resgrp
  virtual_network_name = local.vnetname

  delegation {

    name = "delegation"
    service_delegation {
            name    = "Microsoft.ContainerInstance/containerGroups"
            actions = ["Microsoft.Network/virtualNetworks/subnets/join/action", "Microsoft.Network/virtualNetworks/subnets/prepareNetworkPolicies/action"]
          } 
  }

  depends_on = [
    azurerm_virtual_network.vnet,
  ]
}

# Security Groups

resource "azurerm_network_security_group" "nsgsubnetvms" {     
  location            = var.location
  resource_group_name = local.resgrp
  name                = "nsg-subnet-vms"
  depends_on = [
    azurerm_resource_group.resgrp,
  ]
}

