variable "guac_env_vars" {
    type = map(string)
    description = "envvars"

    #default = {
    #  MYSQL_DATABASE = azurerm_mysql_database.db-guacamoledb.name
    #  MYSQL_USER = azurerm_mysql_server.mysqlserver.administrator_login
    #  MYSQL_PASSWORD = azurerm_mysql_server.mysqlserver.administrator_login_password
    #}

    # DOnt' think we need this now.
    default = {
      MYSQL_HOSTNAME = "mysql-pentestzone.mysql.database.azure.com"
      MYSQL_DATABASE = "guacamoledb"
      MYSQL_USER = "pentest"
      MYSQL_PASSWORD = "notApassword"
      GUACD_HOSTNAME = "guacd"
      GUACD_PORT = "4822"
    }
}

locals {
  
  guac_env_vars = {
        MYSQL_HOSTNAME = "${azurerm_mysql_server.mysqlserver.name}.mysql.database.azure.com"
        MYSQL_DATABASE = "${azurerm_mysql_database.db-guacamoledb.name}"
        MYSQL_USER = "${azurerm_mysql_server.mysqlserver.administrator_login}"
        MYSQL_PASSWORD = "${azurerm_mysql_server.mysqlserver.administrator_login_password}"
        GUACD_HOSTNAME = "guacd"
        GUACD_PORT = "4822"
  }

}

resource "azurerm_container_group" "container_group_guacamole" {
  name                = "cg-guacamole"
  location            = var.location
  resource_group_name = local.resgrp
  ip_address_type     = "Private"
  subnet_ids          = [azurerm_subnet.subnetguacamole.id]
  os_type             = "Linux"

    container {

      name   = "guacamole"
      image  = "guacamole/guacamole:latest"
      cpu    = "0.5"
      memory = "1.0"

      environment_variables = local.guac_env_vars

      ports {
        port     = 8080
        protocol = "TCP"
      }

    }

    container {

      name   = "guacd"
      image  = "guacamole/guacd:latest"
      cpu    = "0.5"
      memory = "1.0"
     

      ports {
        port     = 4822
        protocol = "TCP"
      }

    }

    container {

      name  =  "util"
      image = "daemonchild/useful-linux-ubuntu:latest"
      cpu   = "0.5"
      memory = "0.5"

      ports {
        port     = 22
        protocol = "TCP"
      }

      #Test
      environment_variables = local.guac_env_vars
    

    }

  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_subnet.subnetguacamole,
    azurerm_mysql_server.mysqlserver
  ]

  tags = local.tags

}

