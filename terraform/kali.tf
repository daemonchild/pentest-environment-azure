# Note: az vm image accept-terms --urn kali-linux:kali:kali-20231:2023.1.0

resource "azurerm_network_interface" "vm-kali-nic" {
  
  location              = var.location
  name                  = "vm-kali-nic"

  resource_group_name   = local.resgrp
  ip_configuration {
    name                          = "vm-kali-ipconfig"
    private_ip_address_allocation = "Dynamic"
    subnet_id                     = azurerm_subnet.subnetvms.id
  }
  depends_on = [
    azurerm_subnet.subnetvms,
  ]
}


resource "azurerm_linux_virtual_machine" "vm-kali" {

  location              = var.location
  name                  = "vm-kali"
  network_interface_ids = [azurerm_network_interface.vm-kali-nic.id]
  resource_group_name   = local.resgrp
  size                  = var.kalisku
  admin_username = var.adminuser
  admin_ssh_key {
    username   = var.adminuser
    public_key = var.adminsshkey
  }
  os_disk {
    caching              = "ReadWrite"
    storage_account_type = "Standard_LRS"
  }
  plan {
    name      = "kali-20231"
    product   = "kali"
    publisher = "kali-linux"
  }
  source_image_reference {
    publisher = local.kaliskulist[0]
    offer     = local.kaliskulist[1]
    sku       = local.kaliskulist[2]
    version   = local.kaliskulist[3]
  }
  provisioner "file" {
    source = "${path.module}/../buildscripts/build-vm-kali.sh"  
    destination = "/root/build-vm-kali.sh"
  }
#other code
  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_network_interface.vm-kali-nic,
  ]
}


# Security Groups

resource "azurerm_network_security_group" "nsgvmkali" {
  location            = "uksouth"
  name                = "nsg-vm-kali"
  resource_group_name = local.resgrp
  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_network_interface.vm-kali-nic,
  ]
  
  tags = local.tags
}

resource "azurerm_network_interface_security_group_association" "nsgass-vm-kali" {
  network_interface_id      = azurerm_network_interface.vm-kali-nic.id
  network_security_group_id = azurerm_network_security_group.nsgsubnetvms.id
  depends_on = [
    azurerm_resource_group.resgrp,
    azurerm_network_interface.vm-kali-nic,
    azurerm_network_security_group.nsgsubnetvms,
  ]
}

resource "azurerm_network_security_rule" "nsgvmkali-22internet" {
  access                      = "Allow"
  destination_address_prefix  = "*"
  destination_port_range      = "22"
  direction                   = "Inbound"
  name                        = "AllowSSHfromInternet"
  network_security_group_name = azurerm_network_security_group.nsgvmkali.name
  priority                    = 100
  protocol                    = "Tcp"
  resource_group_name         = local.resgrp
  #source_address_prefix       = "${var.userexternalip}/32"
  source_address_prefix       = "Internet"                           # <-------- during terraform dev only! :)
  source_port_range           = "*"
  depends_on = [
    azurerm_network_security_group.nsgvmkali,
  ]

}

# For certbot testing

resource "azurerm_network_security_rule" "nsgvmkali-80internet" {
  access                      = "Allow"
  destination_address_prefix  = "*"
  destination_port_range      = "80"
  direction                   = "Inbound"
  name                        = "AllowHTTPfromInternet"
  network_security_group_name = azurerm_network_security_group.nsgvmkali.name
  priority                    = 110
  protocol                    = "Tcp"
  resource_group_name         = local.resgrp
  source_address_prefix       = "Internet"
  source_port_range           = "*"
  depends_on = [
    azurerm_network_security_group.nsgvmkali,
  ]
}

resource "azurerm_network_security_rule" "nsgvmkali-443internet" {
  access                      = "Allow"
  destination_address_prefix  = "*"
  destination_port_range      = "443"
  direction                   = "Inbound"
  name                        = "AllowHTTPfromInternet"
  network_security_group_name = azurerm_network_security_group.nsgvmkali.name
  priority                    = 120
  protocol                    = "Tcp"
  resource_group_name         = local.resgrp
  source_address_prefix       = "Internet"
  source_port_range           = "*"
  depends_on = [
    azurerm_network_security_group.nsgvmkali,
  ]
}

resource "azurerm_network_security_rule" "nsgvmkali-denyall" {
  access                      = "Deny"
  destination_address_prefix  = "*"
  destination_port_range      = "*"
  direction                   = "Inbound"
  name                        = "DenyAll"
  network_security_group_name = azurerm_network_security_group.nsgvmkali.name
  priority                    = 999
  protocol                    = "*"
  resource_group_name         = local.resgrp
  source_address_prefix       = "*"
  source_port_range           = "*"
  depends_on = [
    azurerm_network_security_group.nsgvmkali,
  ]
}
