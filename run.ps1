
# Project: Terraform build of a Pentesting Infrastructure
# Author:  Daemonchild
# Purpose: Build an environment for running pentests

#    __ _ _____   _ _ __ ___ 
#   / _` |_  / | | | '__/ _ \
#  | (_| |/ /| |_| | | |  __/
#   \__,_/___|\__,_|_|  \___|   Version
 
                                                 
# Setup Environment 

Function Build-AzurePTEnv ($Mode) {

    If ($Mode -eq "Environment") {

        Write-Host "[HELLO] Extract Terraform Output into Environment Variables" -ForegroundColor Blue
        $timestampNow = Get-Date -Format "yyyyddmm-HHmm"

        # Extract Into Variables
        $EnvHeader = "AZ_TF"

        Write-Host "[LIST] Available Environment Variables:" -ForegroundColor Green
        Get-ChildItem env:* | where-object {$_.Name.StartsWith($EnvHeader)} 

        Write-Host

        # Get Specific Varibles
        $remoteFilename         = "pentest-environment-azure.terraform.tftate"
        $resourceGroupName      = (Get-Item -Path Env:AZ_TF_RESOURCE_GROUP_NAME).Value
        $storageAccountName     = (Get-Item -Path Env:AZ_TF_TFSTATE_STRGACCT_NAME).Value
        $storageContainerName   = (Get-Item -Path Env:AZ_TF_TFSTATE_CONTAINER_NAME).Value
        $storageSASToken        = (Get-Item -Path Env:AZ_TF_TFSTATE_CONTAINER_SAS).Value

    }

    Write-Host "[TERRAFORM] Running Terraform Build" -ForegroundColor Blue

    # Init
    Write-Host "[COPY AND RUN] The following:" -ForegroundColor Green
    Write-Host "terraform init -backend-config=`"key=${remoteFilename}`" -backend-config=`"resource_group_name=${resourceGroupName}`" -backend-config=`"storage_account_name=${storageAccountName}`"  -backend-config=`"container_name=${storageContainerName}`" -backend-config=`"sas_token=${storageSASToken}`""

    Write-Host "[GOODBYE]" -ForegroundColor Blue

}

